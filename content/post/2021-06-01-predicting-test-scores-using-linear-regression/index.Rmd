---
title: "Predicting Test Scores using Linear Regression"
author: "Group 4"
date: 2021-06-01
categories: ["R"]
tags: ["R Markdown", "plot", "regression"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, echo = FALSE, message = FALSE)
```

```{r include=FALSE}
library(tidyverse)
library(here)
library(readxl)
library(ggtext)
library(olsrr)
library(gridExtra)
library(grid)
```

## Getting the Data

We recommend using the `read_xlsx()` and `read_csv()` functions for reading in the appropriate data. You can find the `schools` dataset [here](https://github.com/cprice59/FinalProject-STAT331/blob/main/US_schools_data.xlsx) and the `regionizer` dataset [here](https://github.com/cprice59/FinalProject-STAT331/blob/main/us%20census%20bureau%20regions%20and%20divisions.csv). _If you just want the cleaned dataset (`schools_cleaned`), you can find that [here](https://github.com/cprice59/FinalProject-STAT331/blob/main/us_schools_cleaned.csv)_.

```{r include=FALSE}
schools <- read_xlsx(here::here("US_schools_data.xlsx"))
regionizer <- read_csv(here::here("us census bureau regions and divisions.csv"))
```

```{r}
schools_cleaned <- schools %>%
  select(
    PRIMARY_KEY, TOTAL_EXPENDITURE, INSTRUCTION_EXPENDITURE,
    SUPPORT_SERVICES_EXPENDITURE, OTHER_EXPENDITURE, CAPITAL_OUTLAY_EXPENDITURE,
    ends_with("READING"), ends_with("MATHEMATICS")
  ) %>%
  mutate(
    Year = as.numeric(substr(PRIMARY_KEY, 1, 4)),
    State = substring(PRIMARY_KEY, 6),
    Decade = Year %/% 10 * 10
  )
```

```{r}
schools_cleaned <- schools_cleaned %>%
  pivot_longer(
    c(ends_with("READING"),  ends_with("MATHEMATICS")),
    names_to = c("Grade", "Race", "Sex", "Test"),
    names_sep = "_",
    values_to = "Test Score"
  )

regionizer <- regionizer %>%
  mutate(
    State = str_to_lower(State)
  )

schools_cleaned <- schools_cleaned %>%
  mutate(
    State = str_replace_all(str_to_lower(State), "_", " ")
  ) %>%
  left_join(regionizer, by = "State") %>%
  select(-PRIMARY_KEY)

schools_cleaned <- schools_cleaned %>%
  mutate(
    Grade = str_extract(Grade, "[0-9]$"),
    Sex = str_replace(Sex, "A", "all"),
    across(c("State", "Grade", "Race", "Sex", "Test", "Region", "Division"), as.factor)
  )

schools_cleaned <- schools_cleaned %>%
  filter(!is.na(Region))
```

```{r eval=FALSE, include=FALSE}
# Run this to save CSV file for reference on website
write_csv(schools_cleaned, here::here("us_schools_cleaned.csv"))
```


```{r include=FALSE, eval=FALSE}
temp_school <- schools_cleaned %>%
  select(INSTRUCTION_EXPENDITURE, `Test Score`, Region, State) %>%
  drop_na(INSTRUCTION_EXPENDITURE, `Test Score`)

# summary(temp_school)
# 
# states <- map_data("state")
# map.df <- merge(states,
#                 temp_school,
#                 by.x = "State",
#                 by.y = "Region",
#                 all.x=T)
# map.df <- map.df[order(map.df$order),]
# 
# map.df %>%
#   ggplot(mapping = aes(x=long,y=lat,group=group)) +
#   geom_polygon(aes(fill=REGION)) +
#   geom_path() +
#   coord_map() +
#   labs(title = "Labeled Regions in the Continental US") +
#   map_theme

schools_cleaned_f %>%
  drop_na(INSTRUCTION_EXPENDITURE, `Test Score`) %>%
  ggplot(mapping = aes(x = INSTRUCTION_EXPENDITURE, y = `Test Score`)) +
  geom_smooth() +
  facet_wrap(~ Region, ncol = 1)
```

```{r include=FALSE, eval=FALSE}
schools_cleaned %>%
  drop_na(`Test Score`) %>%
  ggplot(mapping = aes(y = `Test Score`, x = INSTRUCTION_EXPENDITURE, color = Region)) +
  geom_smooth()

schools_cleaned %>%
  drop_na(`Test Score`) %>%
  ggplot(mapping = aes(y = `Test Score`, x = INSTRUCTION_EXPENDITURE)) +
  geom_point() +
  facet_wrap(~ Race)
```

## Exploring Our Cleaned Data

### Some thoughts beforehand:
- **Since we are trying to predict test scores, that will be our _response_ variable**
- We are performing a **_linear regression_**, so we should try and explore variables as if they'd be part of a linear model
- When grouping, we need to pay attention to the number of NAs that exist for certain groups

### How Reading and Math Scores Differ

```{r echo=FALSE}
for_graphs <- schools_cleaned %>%
  drop_na(`Test Score`) %>%
  mutate(
    Test = case_when(
      Test == "READING" ~ "Reading Scores",
      TRUE ~ "Math Scores"
    )
  )

get_boxplots <- function(col) {
  plot_with_col_fill <- for_graphs %>%
    ggplot(aes(x = `Test Score`, y = Test, fill = get(col))) +
    geom_boxplot(width = 0.6,
                 position = position_dodge(width = 0.7)) +
    labs(title = col) +
    geom_text(aes(label = Test, family = "mono", fontface = "bold.italic"),
           stat = "summary",
           size = 3,
           nudge_y = 0.5,
           check_overlap = TRUE) +
    theme(
      legend.position = "none",
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank()
    )
  return(plot_with_col_fill)
}

region <- get_boxplots("Region")
sex <- get_boxplots("Sex")
race <- get_boxplots("Race")

grid.arrange(region, sex, race, ncol = 3, top=textGrob("Distribution of Reading Scores and Math Scores for Region, Sex, and Race"))
```

We can see some variability in Region with the green boxplot mostly but Race showcases math and reading score distributions that look much different between different Races.

#### Let's take a look at the distribution for different regions...

```{r echo=FALSE, fig.width = 10, fig.height = 10}
region_coloring <- c(
  Northeast = "#8414eb",
  South = "#7BAB14",
  Midwest = "#13D3EC",
  West = "#EC2C13"
)

schools_cleaned %>%
  drop_na(`Test Score`) %>%
  mutate(
    Region = fct_relevel(Region, "West", "Midwest", "South", "Northeast"),
    Test = case_when(
      Test == "READING" ~ "Reading Scores",
      TRUE ~ "Math Scores"
    )
  ) %>%
  ggplot(aes(x = `Test Score`, y = Test, fill = Region)) +
  geom_boxplot(width = 0.6,
               position = position_dodge(width = 0.7)) +
  geom_jitter(aes(color = Region), alpha = 0.1, position = position_jitterdodge()) +
  labs(title = "**_Reading and Math Test Scores across Regions_**", y = "", x = "") +
  geom_text(aes(x = 140, label = Test, family = "mono", fontface = "bold.italic"),
           stat = "summary",
           size = 6.5,
           nudge_y = 0.5,
           check_overlap = TRUE,
           vjust = "inward",
           hjust="inward") +
  geom_text(aes(x = 160, y = Test, label = Region, color = Region, family = "mono"),
           stat = "summary",
           size = 5,
           position = position_dodge(width = 0.7)) +
  scale_fill_manual(values = region_coloring) +
  scale_color_manual(values = region_coloring) +
  scale_x_continuous(breaks = c(180, 220, 260, 300), expand = c(0, 0)) +
  scale_y_discrete(expand = c(0.6, 0)) +
  theme_bw() +
  theme(axis.text = element_text(size=13),
        axis.ticks.y=element_blank(),
        axis.text.y = element_blank(),
        plot.title.position = "plot",
        panel.grid = element_blank(),
        legend.position = "none",
        plot.title = element_markdown(lineheight = 1.5, size = 24, family = "serif"),
        panel.border = element_blank())
```

```{r include=FALSE}
schools_cleaned %>%
  mutate(
    Decade = (as.numeric(Year) %/% 10) * 10
  ) %>%
  drop_na(`Test Score`) %>%
  ggplot(mapping = aes(y = `Test Score`, x = INSTRUCTION_EXPENDITURE, color = Region)) +
  geom_point() +
  facet_wrap(Region ~ Decade, ncol = 3)

schools_cleaned %>%
  mutate(
    Decade = (as.numeric(Year) %/% 10) * 10
  ) %>%
  drop_na(`Test Score`) %>%
  ggplot(mapping = aes(y = `Test Score`, x = INSTRUCTION_EXPENDITURE)) +
  geom_point() +
  facet_wrap(Sex ~ Decade)


# NAs for many of the Races for 1990s and 2000s
schools_cleaned %>%
  mutate(
    Decade = (as.numeric(Year) %/% 10) * 10
  ) %>%
  drop_na(`Test Score`) %>%
  ggplot(mapping = aes(y = `Test Score`, x = INSTRUCTION_EXPENDITURE)) +
  geom_point() +
  facet_wrap(Race ~ Decade)
```

```{r}
math_model <- schools_cleaned %>%
  filter(str_to_lower(Test) == "mathematics") %>%
  drop_na(`Test Score`) %>%
  lm(`Test Score` ~ INSTRUCTION_EXPENDITURE, data=.)

reading_model <- schools_cleaned %>%
  filter(str_to_lower(Test) == "reading") %>%
  drop_na(`Test Score`) %>%
  lm(`Test Score` ~ INSTRUCTION_EXPENDITURE, data=.)
```

```{r}
summary(math_model)
summary(reading_model)
```

```{r}
schools_cleaned <- within(schools_cleaned, Test <- relevel(Test, ref="MATHEMATICS"))

test_model <- schools_cleaned %>%
  drop_na(`Test Score`) %>%
  lm(`Test Score` ~ INSTRUCTION_EXPENDITURE + Test, data=.)

summary(test_model)
```

```{r}
test_model <- schools_cleaned %>%
  drop_na(`Test Score`) %>%
  lm(`Test Score` ~ INSTRUCTION_EXPENDITURE + Test + Year, data=.)

summary(test_model)
```

```{r eval=FALSE}
temp <- mutate(drop_na(schools_cleaned, `Test Score`), Scorer = `Test Score`)

model1 <- lm(Scorer ~ INSTRUCTION_EXPENDITURE + Test + Year + Region + Sex + Race + Division + Grade, data=temp)

# We used these functions for STAT 334 (Applied Linear Models) to do variable selection
# all_sub1 <- ols_step_all_possible(model1)
best.sub1 <- ols_step_best_subset(model1)
```

### Citations
- Putting title at top of grid.arrange output https://www.tutorialspoint.com/how-to-add-title-at-the-top-of-multi-plots-created-by-using-gridextra-in-r

